# Stable Diffusion XL Image Generator

This is a powerful and user-friendly command-line tool for generating images using Stable Diffusion XL (SDXL) and its refiner model. It is designed for both ease of use and advanced control, featuring intelligent aspect ratio calculation, user-friendly presets, and a modular, maintainable codebase.

## Features

- **High-Quality Generation**: Utilizes the base SDXL model followed by a refiner for detailed, high-resolution images.
- **Smart Aspect Ratio Calculation**: Specify your desired final image dimensions (e.g., 1920x1080), and the script automatically calculates the optimal generation dimensions to maximize quality and prevent artifacts.
- **Flexible Guidance Control**: Use simple presets (`low`, `medium`, `high`) or specify an exact float value for precise control over prompt adherence.
- **Reproducibility**: Set a specific seed to generate the same image again, or let the script choose a random one.
- **Optimized Performance**: Leverages `torch.compile` and xFormers memory-efficient attention for faster generation on compatible hardware.
- **Clean & Modular Code**: The project is broken into logical files (`main.py`, `generator.py`, `utils.py`) for easy reading and extension.

## Setup & Installation

This project is managed with [Poetry](https://python-poetry.org/).

1.  **Clone or download the project files** into a single directory:
    ```
    sdxl/
    ├── main.py
    ├── generator.py
    ├── utils.py
    ├── Dockerfile
    ├── pyproject.toml
    └── poetry.lock  <-- Generated by `poetry install`
    ```

2.  **Install Poetry**: Follow the [official installation guide](https://python-poetry.org/docs/#installation) for your operating system.

3.  **Install Dependencies**: Navigate to the project's root directory in your terminal and run:
    ```bash
    poetry install
    ```
    This single command will:
    - Create a virtual environment for the project.
    - Read the `pyproject.toml` file.
    - Download PyTorch with CUDA support from the specified source.
    - Download all other dependencies.
    - Create a `poetry.lock` file to ensure future installs are identical.

## Running with Docker (NVIDIA GPU Required)

You can also run this project inside a Docker container, which handles all dependencies for you.

### Prerequisite: NVIDIA Container Toolkit

To give the Docker container access to your GPU, you **must** have the [NVIDIA Container Toolkit](https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/latest/install-guide.html) installed on your system.

### 1. Build the Docker Image

From the root directory of the project (where the `Dockerfile` is located), run the following command to build the image. This may take some time as it downloads the base image and installs all the Python libraries.

```bash
docker build -t sdxl-generator .
```

### 2. Run the Docker Container

To run the generator, you use the `docker run` command.

-   `--gpus all`: This is the crucial flag that gives the container access to your NVIDIA GPUs.
-   `-v $(pwd)/generated_images:/app/generated_images`: This mounts the `generated_images` folder from your host machine into the container. This way, the images are saved directly to your computer, not just inside the container.
-   `sdxl-generator`: The name we gave our image in the build step.
-   All arguments after the image name are passed directly to our `main.py` script.

**Example Run Command:**

```bash
docker run --gpus all -v $(pwd)/generated_images:/app/generated_images sdxl-generator \
    --prompt "an astronaut lounging in a tropical resort on mars, cinematic, 4k" \
    --guidance high
```

## Local Usage (Without Docker)

All commands are run from your terminal in the project's root directory. The main entry point is `main.py`.

The only required argument is `--prompt`. All other arguments have sensible defaults.

### Basic Example

```bash
python main.py --prompt "a dramatic photo of a majestic lion in the savanna, cinematic lighting, 8k"
```

### Command-Line Arguments

| Argument            | Type           | Default                                   | Description                                                                          |
| ------------------- | -------------- | ----------------------------------------- | ------------------------------------------------------------------------------------ |
| `--prompt`          | `string`       | **(Required)** | The positive prompt describing the image you want.                                   |
| `--negative_prompt` | `string`       | `""`                                      | The negative prompt, describing what to avoid.                                       |
| `--model_id`        | `string`       | `stabilityai/stable-diffusion-xl-base-1.0`| The Hugging Face model ID for the base SDXL model.                                   |
| `--guidance`        | `preset/float` | `medium`                                  | Prompt adherence. Can be a float (e.g., `8.2`) or a preset: `artistic`, `low`, `medium`, `high`, `strict`. |
| `--num_images`      | `int`          | `1`                                       | The number of images to generate in a single run.                                    |
| `--seed`            | `int`          | `-1`                                      | The starting seed for generation. A value of `-1` means a random seed will be chosen. |
| `--width`           | `int`          | `1920`                                    | The **final width** of the output image after upscaling.                           |
| `--height`          | `int`          | `1080`                                    | The **final height** of the output image after upscaling.                          |
| `--output_dir`      | `string`       | `generated_images`                        | The directory where generated images will be saved.                                  |
| `--device`          | `string`       | `cuda`                                    | The device to run on (e.g., `cuda`, `cpu`).                                          |
| `--dtype`           | `string`       | `float16`                                 | The torch data type to use (`float16` for performance, `float32` for precision).    |

### Advanced Examples

**1. Generate a portrait image for a phone screen with high guidance:**

```bash
python main.py \
    --prompt "full body portrait of a sci-fi queen on a throne, intricate armor, cinematic" \
    --negative_prompt "blurry, ugly, deformed, cartoon" \
    --width 1080 \
    --height 1920 \
    --guidance high
```
*The script will automatically calculate the optimal generation dimensions (e.g., 768x1344) before upscaling to 1080x1920.*

**2. Generate 5 images with a specific seed for reproducible results:**

```bash
python main.py \
    --prompt "a cozy cabin in a winter forest at night, stars visible, glowing windows" \
    --num_images 5 \
    --seed 42 \
    --output_dir "winter_cabins"
```
*This will generate 5 images with seeds 42, 43, 44, 45, and 46.*

**3. Use a custom model and a very specific guidance value:**

```bash
python main.py \
    --model_id "SG161222/RealVisXL_V4.0" \
    --prompt "ultra-realistic photo of a cat wearing a tiny wizard hat" \
    --guidance 8.7 \
    --width 1280 \
    --height 1280
